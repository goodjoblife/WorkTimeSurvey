"use strict";function testSearchPermission(){var e=FB.getAccessToken(),t={params:{access_token:e}};return Vue.http.get(WTS.constants.backendURL+"me/permissions/search",t).then(function(e){return e.json()}).then(function(e){e.hasSearchPermission?showjs_store.changeAuthState(!0):showjs_store.changeAuthState(!1)}).catch(function(e){showjs_store.changeAuthState(!1)})}var TIME_AND_SALARY_VIEW="TIME_AND_SALARY_VIEW",SEARCH_JOB_TITLE_VIEW="SEARCH_JOB_TITLE_VIEW",SEARCH_COMPANY_VIEW="SEARCH_COMPANY_VIEW",showjs_store={state:{is_logged_in:null,is_authed:null,current_view:null,view_params:{}},changeLoggedInState:function(e){showjs_store.state.is_logged_in=e,!0===showjs_store.state.is_logged_in?testSearchPermission():!1===showjs_store.state.is_logged_in&&(showjs_store.state.is_authed=!1),app.$emit("state-change","log-in-state-change",e),searchBarApp.$emit("state-change")},changeAuthState:function(e){showjs_store.state.is_authed=e,app.$emit("state-change","auth-state-change",e),searchBarApp.$emit("state-change")},changeViewState:function(e,t){showjs_store.state.current_view=e,showjs_store.state.view_params=t,app.$emit("state-change"),searchBarApp.$emit("state-change")}},timeAndSalary=Vue.extend({template:"#app-time-and-salary",data:function(){return{current_page:0,time_and_salary:[],total:0,is_loading:!1,search_result_sort:{},share:showjs_store.state}},events:{load_time_and_salary:function(){if(this.search_result_sort={sort_by:this.share.view_params.sort_by,order:this.share.view_params.order},this.current_page=0,null!==this.share.is_authed)return!0===this.share.is_authed?void this.loadTimeAndSalary(0):!1===this.share.is_authed?"created_at"===this.share.view_params.sort_by&&"descending"===this.share.view_params.order?void this.loadTimeAndSalary(0):void router.setRoute("/latest"):void 0},scroll_bottom_reach:function(){this.share.is_authed&&(this.is_loading||this.loadMorePage())}},methods:{loadMorePage:function(){this.loadTimeAndSalary(this.current_page+1)},loadTimeAndSalary:function(e){var t=this;this.is_loading=!0;var o={params:{sort_by:this.share.view_params.sort_by,order:this.share.view_params.order,page:e,limit:25,access_token:!0===this.share.is_authed&&"undefined"!=typeof FB?FB.getAuthResponse().accessToken:void 0}};this.$http.get(WTS.constants.backendURL+"workings",o).then(function(e){return e.json()}).then(function(o){var r=o.time_and_salary.map(function(e){var t=e.company.name;return e.company.name=Array.isArray(t)?t[0]:t,e});t.time_and_salary=0===e?r:t.time_and_salary.concat(r),0===r.length?t.current_page:t.current_page=e,t.total=o.total,t.is_loading=!1},function(e){t.is_loading=!1,t.current_page})},sortOnChange:function(){var e={created_at_descending:"/latest",created_at_ascending:"/sort/time-asc",week_work_time_descending:"/work-time-dashboard",week_work_time_ascending:"/sort/work-time-asc",estimated_hourly_wage_descending:"/salary-dashboard",estimated_hourly_wage_ascending:"/sort/salary-asc"},t=this.search_result_sort.sort_by+"_"+this.search_result_sort.order;router.setRoute(e[t])}},computed:{section_title:function(){return{created_at_descending:"最新薪時資訊",created_at_ascending:"最舊薪時資訊",week_work_time_descending:"工時排行榜",week_work_time_ascending:"工時排行榜（由低到高）",estimated_hourly_wage_descending:"估算時薪排行榜",estimated_hourly_wage_ascending:"估算時薪排行榜（由低到高）"}[this.search_result_sort.sort_by+"_"+this.search_result_sort.order]},salary_sort_indicator:function(){var e={estimated_hourly_wage_ascending:"high",estimated_hourly_wage_descending:"low"},t=this.search_result_sort.sort_by+"_"+this.search_result_sort.order;return t in e?e[t]:""},work_time_sort_indicator:function(){var e={week_work_time_ascending:"high",week_work_time_descending:"low"},t=this.search_result_sort.sort_by+"_"+this.search_result_sort.order;return t in e?e[t]:""}}}),searchAndGroupByJobTitle=Vue.extend({template:"#app-search-and-group-by-job-title",data:function(){return{job_title_keyword:null,data:[],is_loading:!1,search_result_sort:{},share:showjs_store.state}},events:{load_search_and_group_by_job_title:function(){if(this.share.is_authed,this.share.is_authed,!1===this.share.is_authed)return void router.setRoute("/latest");this.search_result_sort={group_sort_by:this.share.view_params.group_sort_by,order:this.share.view_params.order},this.job_title_keyword=this.share.view_params.job_title,this.loadData(this.job_title_keyword,this.search_result_sort)},data_loaded:function(){if(1===this.data.length){var e=this.$el.querySelector(".accordion__trigger");$(e).trigger("click")}}},methods:{loadData:function(e,t){var o=this;this.data=[],this.is_loading=!0;var r=t.group_sort_by,a=t.order;this.getData(e,r,a).then(function(e){o.data=e.data},function(e){o.data=[]}).then(function(){o.is_loading=!1,o.$emit("data_loaded")})},getData:function(e,t,o){var r={params:{job_title:e,group_sort_by:t,group_sort_order:o,access_token:"undefined"!=typeof FB?FB.getAuthResponse().accessToken:void 0}};return this.$http.get(WTS.constants.backendURL+"workings/search_by/job_title/group_by/company",r)},sortOnChange:function(){var e={week_work_time_descending:"/work-time-dashboard",week_work_time_ascending:"/sort/work-time-asc",estimated_hourly_wage_descending:"/salary-dashboard",estimated_hourly_wage_ascending:"/sort/salary-asc"},t=this.search_result_sort.group_sort_by+"_"+this.search_result_sort.order;router.setRoute("/job-title/"+encodeURIComponent(this.job_title_keyword)+e[t])}},computed:{section_title:function(){return{week_work_time_descending:"工時排行榜",week_work_time_ascending:"工時排行榜（由低到高）",estimated_hourly_wage_descending:"估算時薪排行榜",estimated_hourly_wage_ascending:"估算時薪排行榜（由低到高）"}[this.search_result_sort.group_sort_by+"_"+this.search_result_sort.order]}}}),searchAndGroupByCompany=Vue.extend({template:"#app-search-and-group-by-company",data:function(){return{company_keyword:null,data:[],is_loading:!1,search_result_sort:{},share:showjs_store.state}},events:{load_search_and_group_by_company:function(){if(this.share.is_authed,this.share.is_authed,!1===this.share.is_authed)return void router.setRoute("/latest");this.search_result_sort={group_sort_by:this.share.view_params.group_sort_by,order:this.share.view_params.order},this.company_keyword=this.share.view_params.company,this.loadData(this.company_keyword,this.search_result_sort)},data_loaded:function(){if(1===this.data.length){var e=this.$el.querySelector(".accordion__trigger");$(e).trigger("click")}}},methods:{loadData:function(e,t){var o=this;this.data=[],this.is_loading=!0;var r=t.group_sort_by,a=t.order;this.getData(e,r,a).then(function(e){o.data=e.data},function(e){o.data=[]}).then(function(){o.is_loading=!1,o.$emit("data_loaded")})},getData:function(e,t,o){var r={params:{company:e,group_sort_by:t,group_sort_order:o,access_token:"undefined"!=typeof FB?FB.getAuthResponse().accessToken:void 0}};return this.$http.get(WTS.constants.backendURL+"workings/search_by/company/group_by/company",r)},sortOnChange:function(){var e={week_work_time_descending:"/work-time-dashboard",week_work_time_ascending:"/sort/work-time-asc",estimated_hourly_wage_descending:"/salary-dashboard",estimated_hourly_wage_ascending:"/sort/salary-asc"},t=this.search_result_sort.group_sort_by+"_"+this.search_result_sort.order;router.setRoute("/company/"+encodeURIComponent(this.company_keyword)+e[t])}}});Vue.filter("num",function(e){return e||"-"}),Vue.filter("overtime_frequency_string",function(e){return 0===e?"幾乎不":1===e?"偶爾":2===e?"經常":3===e?"幾乎每天":""}),Vue.filter("employment_type_string",function(e){return"full-time"===e?"全職":"part-time"===e?"兼職(含打工)":"intern"===e?"實習":"temporary"===e?"臨時工":"contract"===e?"約聘雇":"dispatched-labor"===e?"派遣":""}),Vue.filter("salary_type_string",function(e){return"year"===e?"年":"month"===e?"月":"day"===e?"日":"hour"===e?"小時":""}),Vue.filter("formatted_wage_string",function(e){return"number"==typeof e?Math.round(e).toString().replace(/\B(?=(\d{3})+(?!\d))/g,","):e}),Vue.filter("two_digit_month",function(e){return"number"==typeof e?e>9?e.toString():"0"+e:""});var app=new Vue({el:"#app",components:{TIME_AND_SALARY_VIEW:timeAndSalary,SEARCH_JOB_TITLE_VIEW:searchAndGroupByJobTitle,SEARCH_COMPANY_VIEW:searchAndGroupByCompany},data:{currentView:null,share:showjs_store.state},events:{"state-change":function(){this.currentView=this.share.current_view,this.currentView===TIME_AND_SALARY_VIEW?Vue.nextTick(function(){app.$broadcast("load_time_and_salary")}):this.currentView===SEARCH_JOB_TITLE_VIEW?Vue.nextTick(function(){app.$broadcast("load_search_and_group_by_job_title")}):this.currentView===SEARCH_COMPANY_VIEW&&Vue.nextTick(function(){app.$broadcast("load_search_and_group_by_company")})}}}),searchBarApp=new Vue({el:"#section-search",data:{share:showjs_store.state,search_type:"by-company",keyword:"",search_result_sort:{}},methods:{onSubmit:function(){"by-company"===this.search_type?(router.setRoute("/company/"+encodeURIComponent(this.keyword)+"/work-time-dashboard"),this.$emit("submit",this.search_type,this.keyword)):"by-job-title"===this.search_type?(router.setRoute("/job-title/"+encodeURIComponent(this.keyword)+"/work-time-dashboard"),this.$emit("submit",this.search_type,this.keyword)):router.setRoute("/latest")}},events:{"state-change":function(){this.share.current_view===SEARCH_COMPANY_VIEW?(this.search_type="by-company",this.keyword=this.share.view_params.company):this.share.current_view===SEARCH_JOB_TITLE_VIEW&&(this.search_type="by-job-title",this.keyword=this.share.view_params.job_title)}}}),router=Router({"/latest":{on:function(){showjs_store.changeViewState(TIME_AND_SALARY_VIEW,{sort_by:"created_at",order:"descending"})}},"/sort/time-asc":{on:function(){showjs_store.changeViewState(TIME_AND_SALARY_VIEW,{sort_by:"created_at",order:"ascending"})}},"/work-time-dashboard":{on:function(){showjs_store.changeViewState(TIME_AND_SALARY_VIEW,{sort_by:"week_work_time",order:"descending"})}},"/sort/work-time-asc":{on:function(){showjs_store.changeViewState(TIME_AND_SALARY_VIEW,{sort_by:"week_work_time",order:"ascending"})}},"/salary-dashboard":{on:function(){showjs_store.changeViewState(TIME_AND_SALARY_VIEW,{sort_by:"estimated_hourly_wage",order:"descending"})}},"/sort/salary-asc":{on:function(){showjs_store.changeViewState(TIME_AND_SALARY_VIEW,{sort_by:"estimated_hourly_wage",order:"ascending"})}},"/job-title/:job_title/work-time-dashboard":{on:function(e){showjs_store.changeViewState(SEARCH_JOB_TITLE_VIEW,{job_title:decodeURIComponent(e),group_sort_by:"week_work_time",order:"descending"})}},"/job-title/:job_title/sort/work-time-asc":{on:function(e){showjs_store.changeViewState(SEARCH_JOB_TITLE_VIEW,{job_title:decodeURIComponent(e),group_sort_by:"week_work_time",order:"ascending"})}},"/job-title/:job_title/salary-dashboard":{on:function(e){showjs_store.changeViewState(SEARCH_JOB_TITLE_VIEW,{job_title:decodeURIComponent(e),group_sort_by:"estimated_hourly_wage",order:"descending"})}},"/job-title/:job_title/sort/salary-asc":{on:function(e){showjs_store.changeViewState(SEARCH_JOB_TITLE_VIEW,{job_title:decodeURIComponent(e),group_sort_by:"estimated_hourly_wage",order:"ascending"})}},"/company/:company/work-time-dashboard":{on:function(e){showjs_store.changeViewState(SEARCH_COMPANY_VIEW,{company:decodeURIComponent(e),group_sort_by:"week_work_time",order:"descending"})}},"/company/:company/sort/work-time-asc":{on:function(e){showjs_store.changeViewState(SEARCH_COMPANY_VIEW,{company:decodeURIComponent(e),group_sort_by:"week_work_time",order:"ascending"})}},"/company/:company/salary-dashboard":{on:function(e){showjs_store.changeViewState(SEARCH_COMPANY_VIEW,{company:decodeURIComponent(e),group_sort_by:"estimated_hourly_wage",order:"descending"})}},"/company/:company/sort/salary-asc":{on:function(e){showjs_store.changeViewState(SEARCH_COMPANY_VIEW,{company:decodeURIComponent(e),group_sort_by:"estimated_hourly_wage",order:"ascending"})}},"/search-and-group/by-job-title/(.*)":{on:function(e){e=decodeURIComponent(e),router.setRoute("/job-title/"+encodeURIComponent(e)+"/work-time-dashboard")}},"/search-and-group/by-company/(.*)":{on:function(e){e=decodeURIComponent(e),router.setRoute("/company/"+encodeURIComponent(e)+"/work-time-dashboard")}}}).configure({notfound:function(){router.setRoute("/latest")}});$(function(){var e=$(searchBarApp.$el).find("#search-bar-input"),t=searchBarApp;e.autocomplete({source:function(o,r){if("by-company"===t.search_type){e.trigger("company-query-autocomplete-search",o.term);var a=WTS.constants.backendURL+"workings/companies/search",s={params:{key:o.term}};Vue.http.get(a,s).then(function(e){return e.json()}).then(function(e){var t=$.map(e,function(e,t){var r=e._id.name;return Array.isArray(r)&&(r=r.filter(function(e){return e.toLowerCase().indexOf(o.term.toLowerCase())>=0})[0]),{value:r,id:r}});r(t)}).catch(function(e){r([])})}else if("by-job-title"===t.search_type){e.trigger("jot-title-query-autocomplete-search",o.term);var n=WTS.constants.backendURL+"workings/jobs/search",i={params:{key:o.term}};Vue.http.get(n,i).then(function(e){return e.json()}).then(function(e){var t=$.map(e,function(e,t){return{value:e._id,id:e._id}});r(t)}).catch(function(e){r([])})}},select:function(t,o){"by-company"===searchBarApp.search_type?e.trigger("company-query-autocomplete-select",o.item.label):"by-job-title"===searchBarApp.search_type&&e.trigger("job-title-query-autocomplete-select",o.item.label)}})});var callToShareDataApp=new Vue({el:"#call-to-share-data",data:{share:showjs_store.state,user_link:null},watch:{"share.is_logged_in":function(e){!0===e?this.queryRecommendationString():this.user_link=null}},methods:{shareLink:function(){var e=this;FB.ui({method:"share",display:"popup",href:this.user_link,quote:"想邀請身邊的朋友們，一起參與【工時薪資透明化運動】！"},function(t){t&&!t.error_message?e.$emit("fb-share-rec-link-success"):e.$emit("fb-share-rec-link-fail")}),this.$emit("click-fb-share-rec-link")},queryRecommendationString:function(){var e=this,t=FB.getAccessToken(),o={access_token:t};return this.$http.post(WTS.constants.backendURL+"me/recommendations",o).then(function(e){return e.json()}).then(function(t){e.user_link=WTS.constants.siteURL+"?rec_by="+t.recommendation_string}).catch(function(t){e.user_link=null})},clickCopyUrlButton:function(){this.$emit("click-copy-url-button")},clickToSectionFormButton:function(){this.$emit("click-to-section-form-button")}}});!function(e,t){var o="QUERY_PAGE",r=e("#search-bar-input");r.on("company-query-autocomplete-search",function(e,t){ga("send","event",o,"company-query-autocomplete-search",t)}),r.on("job-title-query-autocomplete-search",function(e,t){ga("send","event",o,"job-title-query-autocomplete-search",t)}),r.on("company-query-autocomplete-select",function(e,t){ga("send","event",o,"company-query-autocomplete-select",t)}),r.on("job-title-query-autocomplete-select",function(e,t){ga("send","event",o,"job-title-query-autocomplete-select",t)}),t.$on("submit",function(e,t){"by-company"===e?ga("send","event",o,"company-form-submit",t):"by-job-title"===e&&ga("send","event",o,"job-title-form-submit",t)}),router.on("on","/latest",function(){ga("send","event",o,"visit-latest")}),router.on("on","/search-and-group/by-job-title/(.*)",function(e){ga("send","event",o,"visit-job-title",decodeURIComponent(e))}),router.on("on","/search-and-group/by-company/(.*)",function(e){ga("send","event",o,"visit-company",decodeURIComponent(e))})}(window.jQuery,searchBarApp),function(e,t){t.$on("state-change",function(e,t){void 0!==e&&void 0!==t&&("log-in-state-change"===e?!0===t?ga("send","event","QUERY_PAGE","log-in-success"):!1===t&&ga("send","event","QUERY_PAGE","log-in-fail"):"auth-state-change"==e&&(!0===t?ga("send","event","QUERY_PAGE","authorized"):!1===t&&ga("send","event","QUERY_PAGE","unauthorized")))})}(window.jQuery,app),function(e,t){t.$on("click-fb-share-rec-link",function(){ga("send","event","QUERY_PAGE","click-fb-share-rec-link")}),t.$on("fb-share-rec-link-success",function(){ga("send","event","QUERY_PAGE","fb-share-rec-link-success")}),t.$on("fb-share-rec-link-fail",function(){ga("send","event","QUERY_PAGE","fb-share-rec-link-fail")}),t.$on("click-copy-url-button",function(){ga("send","event","QUERY_PAGE","click-copy-url-button")}),t.$on("click-to-section-form-button",function(){ga("send","event","QUERY_PAGE","click-to-section-form-button")})}(window.jQuery,callToShareDataApp),$(window).on("scroll",function(){$(window).scrollTop()+window.innerHeight>=$(document).height()-100&&app.currentView===TIME_AND_SALARY_VIEW&&app.$broadcast("scroll_bottom_reach")}),router.init(["/"]);